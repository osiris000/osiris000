#!/bin/bash

# Variables de entorno configurables
SESSION_NAME="${SESSION_NAME:-my_tmux_session_$(date +%s)}"
VIDEO_FILE="${VIDEO_FILE:-/var/www/osiris000/bin/com/datas/ffmpeg/intro.mp4}"
ERROR_LOG="${ERROR_LOG:-mpv_errors.log}"
COMMAND_PANEL0="${COMMAND_PANEL0:-$OSIRIS000_BASEPATH/osiris}"
COMMAND_PANEL1="${COMMAND_PANEL1:-$HOME/otvs -screen -prompt}"
COMMAND_PANEL2="${COMMAND_PANEL2:-$OSIRIS000_BIN/pilottv}"
COMMAND_PANEL3="${COMMAND_PANEL3:-$OSIRIS000_BIN/scripts/mpvc.sh}"

# Crear una nueva sesión de tmux
tmux new-session -d -s $SESSION_NAME -n window0

# Dividir la ventana en dos paneles: izquierda (osiris) y derecha (para las tres filas)
tmux split-window -h -t $SESSION_NAME:window0 -p 25

# En el panel derecho (que será el panel 1), dividir en tres paneles horizontales
tmux split-window -v -t $SESSION_NAME:window0.1 -p 33
tmux split-window -v -t $SESSION_NAME:window0.1

# Enviar comandos a cada panel
tmux send-keys -t $SESSION_NAME:window0.0 "$COMMAND_PANEL0" C-m # osiris a la izquierda
tmux send-keys -t $SESSION_NAME:window0.1 "$COMMAND_PANEL2" C-m # pilottv en la parte superior derecha
tmux send-keys -t $SESSION_NAME:window0.2 "$COMMAND_PANEL1" C-m # otvs en la parte media derecha
tmux send-keys -t $SESSION_NAME:window0.3 "$COMMAND_PANEL3" C-m # mpv en la parte inferior derecha

# Habilitar el uso del ratón
tmux set -g mouse on

# Esperar un momento para que los comandos se ejecuten
sleep 2

# Verificación de errores en el panel 3
tmux send-keys -t $SESSION_NAME:window0.3 "wait" C-m
sleep 2
tmux capture-pane -t $SESSION_NAME:window0.3 -pS -1000 | grep -q "Error"

if [ $? -eq 0 ]; then
  echo "Error al cargar mpv. Verifica el archivo de log: $ERROR_LOG"
  tmux send-keys -t $SESSION_NAME:window0.3 "bash" C-m
fi

# Adjuntar a la sesión
tmux attach-session -t $SESSION_NAME

